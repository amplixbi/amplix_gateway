window.IG$||(window.IG$={}),IG$._wcollab_data={msg_template:{cls:"kiwi-messagelist-item",items:[{cls:"kiwi-messagelist-message kiwi-messagelist-message--modern kiwi-messagelist-message--authorfirst kiwi-messagelist-message-notice",items:[{cls:"kiwi-messagelist-modern-left",id:"avatar"},{cls:"kiwi-messagelist-modern-right",items:[{items:[{cls:"kiwi-messagelist-top",items:[{cls:"kiwi-messagelist-nick",items:[{cls:"kiwi-messagelist-nick-prefix",type:"span",innerHtml:"{actor.nick}"}]},{cls:"kiwi-messagelist-time"}]},{cls:"kiwi-messagelist-body",innerHtml:"{message}"}]}]},{cls:"kiwi-messagelist-modern-right-pad"}]}]},workspace_template:{cls:"kiwi-workspace",items:[{cls:"kiwi-container kiwi-container--sidebar-open",items:[{cls:"kiwi-header kiwi-theme-bg",items:[{cls:"kiwi-header-name"},{cls:"kiwi-header-options"}]},{cls:"kiwi-container-content",id:"messagecontainer",items:[{cls:"kiwi-messagelist",id:"messagelist",items:[{cls:"kiwi-messagelist-inner",id:"messagelist-inner"}]}]}]},{cls:"kiwi-controlinput kiwi-theme-bg",items:[{cls:"kiwi-controlinput-selfuser"},{cls:"kiwi-controlinput-inner",items:[{cls:"kiwi-controlinput-form",type:"form",items:[{cls:"kiwi-typinguserslist"},{cls:"kiwi-controlinput-input-wrap",items:[{cls:"kiwi-ircinput kiwi-controlinput-input",items:[{cls:"kiwi-ircinput-editor",id:"ircinput",attr:{placeholder:"Send a message...",contenteditable:"true",role:"textbox",spellcheck:"true"}}]}]},{cls:"kiwi-controlinput-send fa fa-paper-plane",type:"button",id:"btn_send"}]}]}]}]},welcome_template:{cls:"kiwi-wrap kiwi-theme-bg",items:[{cls:"kiwi-startup-common kiwi-welcome-simple kiwi-welcome-simple--recaptcha",items:[{cls:"kiwi-startup-common-section kiwi-startup-common-section-connection",items:[{cls:"u-form u-form--big kiwi-welcome-simple-form",type:"form",items:[{type:"h2"},{cls:"u-input-text",id:"robo_form1",items:[{type:"label",attr:{for:"txt_nick"},innerHtml:"{nick}"},{cls:"u-input-text-inputs",items:[{type:"input",id:"txt_nick",cls:"u-input"}]}]},{type:"button",id:"robo_form2",cls:"u-button u-button-primary u-submit kiwi-welcome-simple-start",innerHtml:"{start}",handler:function(e){e.preventDefault(),e.stopPropagation();this._connect_channel()}},{items:[{cls:"fn-sponsor",innerHtml:"{sponsor}"}]}]}]},{cls:"kiwi-startup-common-section kiwi-startup-common-section-info",items:[{cls:"kiwi-startup-common-section-info-content",innerHtml:"{startup}"}]}]}]}},IG$._wcollab=function(e){this._settings=e||{},e._container&&this._render(),e._container||(e._container=e._html);var t=$("#popup_error",e._container);$("#btn_close",t).bind("click",(function(){t.fadeOut()}))},IG$._wcollab.prototype={_render:function(){var e=this,t=e._settings,i=t._container,s=e._html={},n=window.location.href.split("/");t._embeded_html=!0,t.message=t.message||{start:"Start",nick:"Nick",startup:"<p>Welcome to your AI Data Explorer.<br/><br/> <a href='http://www.amplixbi.com'>amplixbi</a> robo assist are here for help you.<br> To learn more about intelligent helper for your business, please visit <a href='https://amplixbi.com'>our website</a>.</p>",sponsor:"<span>AI Data Explorer<br></span>Created by <a href='http://www.amplixbi.com/'>amplixbi.com</a>"},s.app_cuddle=$('<div id="app_cuddle"></div>').appendTo(i),s.loading=$(['<div id="loading" class="loading">','    <div class="loading_bg"></div>','    <div class="loading-msg"><img src="./images/ico_loading_circle.png" width="30" height="30" alt="" /></div>',"</div>"].join("")).appendTo(i),s.main_loading=$(['<div class="mainLoadingWrap" id="main_loading">','<div class="mainLoading">',"    <p>Calling agent to help you.<br/>I am more then happy to serve you!<br/><span>Please wait a moment.</span></p>",'    <div class="progressWrap">','        <p class="line"></p>','        <img src="./images/ico_mainloading.png" width="18" height="14" alt="" />',"    </div>","</div>","</div>"].join("")).appendTo(i),s.popup_error=$(['<div id="popup_error" class="popupContainer">','<div class="popupWrap">','    <div class="popupContentWrap">','        <div class="popupImgWrap">','            <img src="./images/img_alert.png" width="80" height="80" alt="" />',"        </div>",'        <div id="msg_area" class="popupContent">','            <p id="msg_title" class="title"></p>','            <p id="msg_content"></p>',"        </div>",'        <div class="popupBtnWrap">','            <a id="btn_close" class="btn close">Close</a>',"        </div>","    </div>","</div>",'<div class="popupDimmed"></div>',"</div>"].join("")).appendTo(i),t.html=s.app_cuddle,e._init_setting();let a="";for(let e=3;e<n.length&&"launcher"!=n[e];e++)a+="/"+n[e];t.ws_path||(t.ws_path=a+"/websocket/collaborate"),t.request_url||(t.request_url=a+"/krcp");var o=s.popup_error;$("#btn_close",o).bind("click",(function(){o.fadeOut()}))},_init_setting:function(){var e=this._settings,t=window.location.href.split("/");e.protocol||(e.protocol="https:"==t[0]?"wss":"ws"),e.url||(e.url=t[2])},_init:function(){var e,t=this;e=t._settings,t._init_setting();var i,s=e.protocol+"://"+e.url+e.ws_path;t._userdetail=e.userdetail;try{(i=t.__ws=new WebSocket(s)).onopen=function(e){t.onopen(e)},i.onmessage=function(e){t.onmessage(e)},i.onclosed=function(e){t.onclosed(e)},i.onclosing=function(e){t.onclosing(e)}}catch(e){}},onopen:function(e){this._send_ws("_call_","login",{})},onmessage:function(e){var t,i=this,s=JSON.parse(e.data),n=i._settings,a={};if("_irc_"==s.application){switch(s.action){case"login":t="Logged in user <ul><li>"+s.content.name+" ("+s.content.id+")</li><li>"+s.content.email+"</li></ul>";break;case"writecontent":t="Content updated on server! <ul><li>"+s.content.nodepath+"</li></li>By: "+s.content.username+"</li></ul>";break;case"message":if($("#main_loading",n._container).fadeOut(),(a=s.content).nlp_entities&&a.nlp_entities.length){var o=a.message;for(let e=0;e<a.nlp_entities.length;e++){let t=a.nlp_entities[e],i=t.entity,s=t.utteranceText||t.sourceText,n=o.indexOf("{"+i+"}");for(;n>-1;){let e=o.indexOf("}",n);n=(o=o.substring(0,n)+s+o.substring(e+1)).indexOf("{"+i+"}")}}a.before_message=t,a.message=o}if((t=a.message)&&t.startsWith("#ACT")&&n.instance)return void n.instance.requestRoboAction.apply(n.instance,[i,a,function(e,s){a.orig_message=t,a.message=e.toString(),a.visual_data=s,i._appendMsg(a)}]);if(t&&t.indexOf("@")>-1&&n.instance)return void n.instance.requestRoboFormat.apply(n.instance,[i,a,function(e){a.orig_message=t,a.message=e,i._appendMsg(a)}]);t||(a.message=IRm$.r1("ROBO_ERR_PROCESSING"))}i._appendMsg(a)}},_appendMsg:function(e){var t,i,s=this,n=s._settings,a=($("#messagecontainer",n._container),s.messagelist),o=s.messagelist_inner;function r(){s.theight=theight=o.height(),a.animate({scrollTop:theight},"slow");var i=$("a",t);$.each(i,(function(t,i){var a=$(i);a.bind("click",(function(t){t.preventDefault(),t.stopPropagation();var i=a.attr("amp_reply");""===i&&(i=a.text()),i&&(i.startsWith("#ACT_")?n.instance.requestRoboAction.apply(n.instance,[s,{message:i,actor:{nick:"me",self:!0}},function(t){e.orig_message=e.message,e.message=t.toString()}]):s._send_ws("_call_","message",{message:i,actor:{nick:"me",self:!0}},!0),$("#ircinput",n._container).focus())}))}))}theight=s.theight||0,s._ttimer&&(clearTimeout(s._ttimer),s._ttimer=-1,s._ttimer_c&&(s._ttimer_c.html.html(s._ttimer_c.message.join(" ")),s._ttimer_c.html.trigger("animation_finished"),s._ttimer_c=null)),t=$("<div></div>").appendTo(o),i=s.draw_area(t,IG$._wcollab_data.msg_template,e,!e.actor.self&&!e.visual_data),e.actor&&e.actor.self?i.addClass("igc_self_msg"):i.addClass("igc_bot_msg"),e.visual_data?(e._html=i,s._appendChart(e)):e.actor.self?r():i.bind("animation_finished",(function(e){r()}))},_appendChart:function(e){var t=$(".kiwi-messagelist-body",e._html),i=$("<div class='robo-chart'></div>").appendTo(t),s=e.visual_data;echarts.init(i[0]).setOption(s)},closeSession:function(){var e=this.__ws;e&&e.close(),this.__ws=null},_send_ws:function(e,t,i,s){var n,a=this,o=a.__ws,r=a._channel_info,c={application:e,action:t,instance:r.instance,channel:r.channel,id:a.guid(),content:i};if(n=c.content.message,s&&n&&n.indexOf(";")>0&&(c.content.message=n.substring(0,n.indexOf(";"))),1!==o.readyState&&0!==o.readyState)return a._appendMsg({actor:{},message:"Socket closed! Reconnect to bot"}),void a._init();if(o.send(JSON.stringify(c)),s&&n&&n.indexOf(";")>0&&(i.message=n.substring(n.indexOf(";")+1)),"message"===t)a._appendMsg(i)},load_app:function(){var e=this,t=e._settings,i=t.instance,s=t.html;e._loaded?$("#ircinput",t._container).focus():(e._loaded=!0,e.rootdiv=s,e.rootdiv.empty(),e._pages={},setTimeout((function(){if($("#main_loading",t._container).fadeOut(),t.html.fadeIn(),e._load_page("welcome_template"),i&&i.dlgLogin&&i.dlgLogin.logininfo){$("#txt_nick",t._container).val(i.dlgLogin.logininfo.username),$("#robo_form1",t._container).hide(),$("#robo_form2",t._container).hide(),setTimeout((function(){$("#robo_form2",t._container).trigger("click")}),800)}}),800))},_load_page:function(e){var t,i=this,s=i._settings;$.each(i._pages,(function(t,i){t==e?i.region.show():i.region.hide()})),i._pages[e]||(t=i.draw_area(i.rootdiv,IG$._wcollab_data[e],s.message),i._pages[e]={pname:e,region:t})},draw_area:function(e,t,i,s){return this._draw_sub(e,t,i,s)},setLoading:function(e){var t=this._settings;$("#loading",t._container)[e?"show":"fadeOut"]()},showErrorMessage:function(e,t){var i=this._settings,s=$("#popup_error",i._container);msg_title=$("#msg_title",s),msg_content=$("#msg_content",s),msg_title.html(e),msg_content.html(t),s.fadeIn()},_send_ajax:function(e,t){var i=this,s=i._settings;e.uniquekey=i._get_uniquekey(),window.Pace&&window.Pace.start(),i.setLoading(!0),$.ajax({url:s.request_url+"/"+e.ack,data:JSON.stringify(e),dataType:"json",type:"POST",async:!0,contentType:"application/json; charset=UTF-8",timeout:6e5,beforeSend:function(e,t){},cache:!1,crossDomain:!1,processData:!0,success:function(e,s,n){window.Pace&&window.Pace.stop();var a=(e=e||{errorcode:"0xffff",errormsg:"Server incorrect responding"}).errorcode;if(i.setLoading(!1),null!=a&&a.length>0){var o=!0;t&&(o=t.func.apply(t.scope||i,[e,!0])),!1!==o&&i.showErrorMessage("Error!",e.errormsg)}else t&&t.func.apply(t.scope||i,[e,!1])},error:function(e,t,s){window.Pace&&window.Pace.stop(),i.setLoading(!1);i.showErrorMessage("Error!","Server URL Connection Failed")}})},_get_uniquekey:function(){var e=new Date;return""+e.getFullYear()+(1+e.getMonth())+e.getDate()+e.getHours()+e.getMinutes()+e.getSeconds()},_draw_sub:function(e,t,i,s){var n,a,o,r=this,c=t.type||"div",l=["<"+c];if(t.cls&&l.push(" class='"+t.cls+"'"),t.name&&l.push(" name='"+t.name+"'"),t.id&&l.push(" id='"+t.id+"'"),t.attr&&$.each(t.attr,(function(e,t){l.push(" "+e+"='"+t+"'")})),l.push("></"+c+">"),l=$(l.join("")).appendTo(e),t.handler&&l.bind("click",(function(e){t.handler.apply(t.scope||r,[e])})),t.items)$.each(t.items,(function(e,t){r._draw_sub(l,t,i,s)}));else if(t.innerHtml)if(i&&"{"==t.innerHtml.charAt(0)&&"}"==t.innerHtml.charAt(t.innerHtml.length-1))if((n=t.innerHtml.substring(1,t.innerHtml.length-1)).indexOf(".")>-1){for(n=n.split("."),a=i,o=0;o<n.length;o++){if(!a[n[o]]){a=null;break}a=a[n[o]]}l.append(a||"")}else if("message"==n&&s)if(i[n].indexOf("<a")<0){let e=i[n].split(" "),t=0,s=5+Math.floor(50*Math.random()),a="";!function i(){if(t<e.length){let n=e[t];a+=" "+n,t++,l.html(a),t%40==0&&r.messagelist.animate({scrollTop:r.messagelist_inner.height()},"slow"),s=(" "==n||"."==n?60:5)+Math.floor(120*Math.random()),r._ttimer_c={html:l,message:e},r._ttimer=setTimeout(i,s)}else r._ttimer=-1}()}else l.append(i[n]||""),setTimeout((function(){l.trigger("animation_finished")}),10);else l.append(i[n]||"");else l.append(t.innerHtml);return l},_connect_channel:function(){var e=this,t=e._settings,i=$("#txt_nick",t._container);if(!i.val())return i.addClass("required_field"),void e.showErrorMessage("Field Input","Nick name is required!");i.removeClass("required_field"),e._send_ajax({ack:"collaborate",payload:{cmd:"request_channel"},mbody:e._settings.channel_name?{channel_name:"#"+e._settings.channel_name,nick:i.val()}:{nick:i.val()},_mts_:e._settings._mts_||IG$._g$a},{func:function(i,s){s||(e._channel_info=i.result,e._load_page("workspace_template"),e.messagelist=$("#messagelist",e._settings._container),e.messagelist_inner=$("#messagelist-inner",e.messagelist),e._init_ws(),e._init(),$("#ircinput",t._container).focus())}})},_init_ws:function(){var e=this,t=e._pages.workspace_template,i=$("#ircinput",t.region);e._msg_hist=e._msg_hist||[],e._msg_hist_back=e._msg_hist_back||0,i.keydown((function(t){13==t.which?(t.preventDefault(),t.stopPropagation(),e._send_msg()):38==t.which?e._msg_hist.length>e._msg_hist_back&&(e._msg_hist_back++,i.html(e._msg_hist[e._msg_hist.length-e._msg_hist_back])):40==t.which&&e._msg_hist_back>0&&e._msg_hist.length>e._msg_hist_back-1&&(e._msg_hist_back--,i.html(e._msg_hist[e._msg_hist.length-e._msg_hist_back]))})),$("#btn_send",t.region).bind("click",(function(t){t.preventDefault(),t.stopPropagation(),e._send_msg()}))},_send_msg:function(){var e=this,t=e._pages.workspace_template,i=$("#ircinput",t.region),s=i.html();s&&(i.empty(),e._msg_hist=e._msg_hist||[],e._msg_hist_back=0,e._msg_hist.push(s),e._send_ws("_call_","message",{message:s,actor:{nick:"me",self:!0}}))},guid:function(){var e,t;if(IG$._guid_lut)e=IG$._guid_lut;else for(e=IG$._guid_lut=[],t=0;t<256;t++)e[t]=(t<16?"0":"")+t.toString(16);var i=4294967295*Math.random()|0,s=4294967295*Math.random()|0,n=4294967295*Math.random()|0,a=4294967295*Math.random()|0;return e[255&i]+e[i>>8&255]+e[i>>16&255]+e[i>>24&255]+"-"+e[255&s]+e[s>>8&255]+"-"+e[s>>16&15|64]+e[s>>24&255]+"-"+e[63&n|128]+e[n>>8&255]+"-"+e[n>>16&255]+e[n>>24&255]+e[255&a]+e[a>>8&255]+e[a>>16&255]+e[a>>24&255]}};